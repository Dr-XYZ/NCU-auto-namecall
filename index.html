<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå‹•è¨˜æ†¶é€²åº¦ - é»åæƒæå™¨</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        input[type="text"], input[type="number"] {
            width: 100%; padding: 10px; margin-bottom: 10px; font-size: 14px;
            border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;
        }
        .controls { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            padding: 10px 20px; font-size: 16px; cursor: pointer;
            border: none; border-radius: 5px; color: white;
        }
        #btnStart { background-color: #28a745; }
        #btnStart:hover { background-color: #218838; }
        #btnStart:disabled { background-color: #ccc; cursor: not-allowed; }
        
        #btnStop { background-color: #dc3545; }
        #btnStop:hover { background-color: #c82333; }
        
        #btnClear { background-color: #6c757d; font-size: 14px; }
        #btnClear:hover { background-color: #5a6268; }

        .row { display: flex; gap: 20px; margin-bottom: 10px; }
        .col { flex: 1; }

        .log { padding: 15px; background: #f8f9fa; border: 1px solid #ddd; height: 350px; overflow-y: auto; font-family: monospace; }
        .item { margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 2px;}
        .highlight { color: #0056b3; font-weight: bold; }
        .saved-msg { color: #856404; background-color: #fff3cd; padding: 5px; border-radius: 3px; display: inline-block; margin-bottom: 10px;}
    </style>
</head>
<body>

    <h2>NCU è‡ªå‹•é»å (è‡ªå‹•è¨˜æ†¶é€²åº¦ç‰ˆ)</h2>
    
    <div id="memoryMsg" style="display:none;" class="saved-msg">
        ğŸ’¡ å·²è‡ªå‹•è¼‰å…¥ä¸Šæ¬¡çš„é€²åº¦ï¼šID <span id="lastIdDisplay"></span>
    </div>

    <label>åŸå§‹é€£çµ (æœƒè‡ªå‹•æ›´æ–°ç‚ºä¸Šæ¬¡é€²åº¦)ï¼š</label>
    <div style="display: flex; gap: 5px;">
        <input type="text" id="urlInput" value="https://ncueeclass.ncu.edu.tw/course/joinOnSite?courseId=35214&date=2025-09-25&timeTableType=2&timeTableId=12501&week=0&classTimeId=0">
        <button id="btnClear" onclick="clearMemory()" title="æ¸…é™¤è¨˜æ†¶ä¸¦é‚„åŸé è¨­å€¼">ğŸ—‘ï¸ æ¸…é™¤è¨˜æ†¶</button>
    </div>

    <div class="row">
        <div class="col">
            <label>å˜—è©¦æ¬¡æ•¸ï¼š</label>
            <input type="number" id="retryCount" value="20">
        </div>
        <div class="col">
            <label>æœ€å°ç§’æ•¸ï¼š</label>
            <input type="number" id="minSec" value="1.5" step="0.1">
        </div>
        <div class="col">
            <label>æœ€å¤§ç§’æ•¸ï¼š</label>
            <input type="number" id="maxSec" value="3.5" step="0.1">
        </div>
    </div>

    <div class="controls">
        <button id="btnStart" onclick="startProcess()">ğŸš€ ç¹¼çºŒ/é–‹å§‹æƒæ</button>
        <button id="btnStop" onclick="stopProcess()" disabled>â›” åœæ­¢</button>
        <span id="statusText" style="font-weight: bold; color: #d9534f; margin-left: auto;"></span>
    </div>

    <div id="logArea" class="log">æº–å‚™å°±ç·’...</div>

    <script>
        const logArea = document.getElementById('logArea');
        const btnStart = document.getElementById('btnStart');
        const btnStop = document.getElementById('btnStop');
        const statusText = document.getElementById('statusText');
        const urlInput = document.getElementById('urlInput');
        const memoryMsg = document.getElementById('memoryMsg');
        
        let isRunning = false;
        const STORAGE_KEY = 'ncu_last_timetable_id'; // å®šç¾©å„²å­˜çš„é‘°åŒ™åç¨±

        // --- é é¢è¼‰å…¥æ™‚åŸ·è¡Œ ---
        window.onload = function() {
            const savedId = localStorage.getItem(STORAGE_KEY);
            if (savedId) {
                // å¦‚æœæœ‰å­˜æª”ï¼Œæ›´æ–°ç¶²å€æ¡†
                updateUrlInputWithId(savedId);
                // é¡¯ç¤ºæç¤ºè¨Šæ¯
                document.getElementById('lastIdDisplay').innerText = savedId;
                memoryMsg.style.display = 'block';
                log(`ğŸ“‚ è®€å–å­˜æª”æˆåŠŸï¼Œä¸Šæ¬¡åŸ·è¡Œåˆ° ID: ${savedId}`);
            }
        };

        // æ¸…é™¤è¨˜æ†¶
        function clearMemory() {
            localStorage.removeItem(STORAGE_KEY);
            alert("è¨˜æ†¶å·²æ¸…é™¤ï¼ä¸‹æ¬¡é‡æ–°æ•´ç†é é¢å°‡æ¢å¾©é è¨­ç¶²å€ã€‚");
            location.reload(); // é‡æ–°æ•´ç†é é¢
        }

        // è¼”åŠ©å‡½å¼ï¼šæ›´æ–°ç¶²å€æ¡†è£¡çš„ ID
        function updateUrlInputWithId(newId) {
            try {
                let currentUrl = urlInput.value;
                let urlObj = new URL(currentUrl);
                urlObj.searchParams.set('timeTableId', newId);
                // åŒæ™‚ä¹Ÿæ›´æ–°æ—¥æœŸç‚ºä»Šå¤©ï¼Œæ–¹ä¾¿ä½¿ç”¨è€…
                urlObj.searchParams.set('date', getTodayDateString());
                urlInput.value = urlObj.toString();
            } catch (e) {
                console.error("ç¶²å€è§£æå¤±æ•—", e);
            }
        }

        function log(message) {
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function getTodayDateString() {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getRandomFloat(min, max) {
            return Math.random() * (max - min) + min;
        }

        function stopProcess() {
            isRunning = false;
            log("ğŸ›‘ ä½¿ç”¨è€…å·²æ‰‹å‹•åœæ­¢");
            btnStart.disabled = false;
            btnStop.disabled = true;
            statusText.innerText = "å·²åœæ­¢";
        }

        async function startProcess() {
            const rawUrl = urlInput.value.trim();
            const maxRetries = parseInt(document.getElementById('retryCount').value, 10);
            const minSec = parseFloat(document.getElementById('minSec').value);
            const maxSec = parseFloat(document.getElementById('maxSec').value);

            if (!rawUrl) { alert("è«‹è¼¸å…¥ç¶²å€"); return; }
            if (minSec > maxSec) { alert("æœ€å°ç§’æ•¸ä¸èƒ½å¤§æ–¼æœ€å¤§ç§’æ•¸"); return; }

            let urlObj;
            try { urlObj = new URL(rawUrl); } catch (e) { alert("ç¶²å€æ ¼å¼éŒ¯èª¤"); return; }

            const todayStr = getTodayDateString();
            urlObj.searchParams.set('date', todayStr);
            
            let currentId = parseInt(urlObj.searchParams.get('timeTableId'));
            if (isNaN(currentId)) { alert("ç¶²å€å…§ç¼ºå°‘ timeTableId"); return; }

            // é–‹å§‹åŸ·è¡Œåˆå§‹åŒ–
            isRunning = true;
            btnStart.disabled = true;
            btnStop.disabled = false;
            memoryMsg.style.display = 'none'; // éš±è—æç¤º
            logArea.innerHTML = "";
            log(`ğŸ“… è¨­å®šæ—¥æœŸï¼š${todayStr}`);

            for (let i = 0; i < maxRetries; i++) {
                if (!isRunning) break;

                const thisRunId = currentId + i;

                // --- é—œéµæ­¥é©Ÿï¼šå„²å­˜é€²åº¦ ---
                localStorage.setItem(STORAGE_KEY, thisRunId);
                // åŒæ­¥æ›´æ–°è¼¸å…¥æ¡†ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°ç¾åœ¨è·‘åˆ°å“ª
                updateUrlInputWithId(thisRunId); 

                urlObj.searchParams.set('timeTableId', thisRunId);
                const targetUrl = urlObj.toString();
                const waitTimeRaw = getRandomFloat(minSec, maxSec);
                const waitTimeDisplay = waitTimeRaw.toFixed(2);

                statusText.innerText = `åŸ·è¡Œä¸­ ID: ${thisRunId}`;
                log(`é–‹å•Ÿ: <span class="highlight">ID=${thisRunId}</span> (åœç•™ ${waitTimeDisplay}s)`);

                const newWin = window.open(targetUrl, '_blank', 'width=600,height=400');

                if (!newWin) {
                    log("âŒ è¦–çª—è¢«æ””æˆªï¼è«‹å…è¨±å½ˆå‡ºè¦–çª—ã€‚");
                    stopProcess();
                    return;
                }

                await new Promise(resolve => setTimeout(resolve, waitTimeRaw * 1000));
                if (!newWin.closed) newWin.close();
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            if (isRunning) {
                log("âœ… ç¯„åœæƒæå®Œæˆï¼");
                stopProcess();
            }
        }
    </script>
</body>
</html>
